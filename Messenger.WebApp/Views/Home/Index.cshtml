@model string
@{
    ViewData["Title"] = "مسنجر اختصاصی ایران اروپا";
    Layout = "~/Views/Shared/_ChatzyLayout.cshtml";
}
@using System.Security.Claims
@using Messenger.Tools

@section Styles {
    <style>
        
    </style>
}

<input type="hidden" value="@User.Claims.FirstOrDefault(c => c.Type == "UserId")?.Value" id="userId" />
<input type="hidden" value="@User.Claims.FirstOrDefault(c => c.Type == "NameFamily")?.Value" id="fullName" />
<input type="hidden" value="@(ViewData["userProfilePic"] ?? "UserIcon.png")" id="userProfilePic" />
<input type="hidden" value="@(ViewData["baseUrl"] ?? "")" id="baseUrl" />
<input type="hidden" value="" id="groupType" />
<input type="hidden" value="@Model" id="linkToChatId" />
<input type="hidden" value="@User.Claims.FirstOrDefault(c => c.Type == ClaimTypes.Role)?.Value" id="userRole" />

<div id="main-page-wrapper" class="hide-on-chat-select">

    <!-- header starts -->
    <header id="header-main" class="main-header section-b-space hide-on-chat-select">
        <div class="custom-container">
            <div class="header-panel">
                <div class="d-flex align-items-center gap-2">
                    <a href="#" data-bs-toggle="offcanvas" data-bs-target="#offcanvasLeft">
                        <i class="iconsax icon-btn" data-icon="text-align-left"> </i>
                    </a>
                </div>
                <div class="d-flex align-items-center gap-2">
                    <img class="img-fluid logo" src="~/chatzy/assets/images/LOGO-118x118.png" alt="logo">
                    <span class="fw-bold dark-text">Iran-europe</span>
                </div>

                <div class="d-flex align-items-center gap-sm-3 gap-2">
                    <!-- دکمه جستجو برای همه نقش‌ها -->
                    <a href="#" data-bs-toggle="offcanvas" data-bs-target="#search-offcanvas">
                        <i class="iconsax icon-btn" data-icon="search-normal-2"></i>
                    </a>
                    
                    <div class="dropdown more-options dropdown-menu-end">
                        <a class="btn dropdown-toggle mt-0 p-0" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="iconsax icon-btn" data-icon="menu-meatballs"> </i>
                        </a>

                        <ul class="dropdown-menu">
                            <li>
                                <a href="#" onclick="GetSavedMessages()" class="dropdown-item">
                                    <i class="iconsax icon" data-icon="save-2"></i>
                                    Saved Message
                                </a>
                            </li>

                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </header>
    <!-- header end -->

    <div id="main-content-body" class="hide-on-chat-select">

        <!-- chat section starts -->
        <section class="chat-section pt-0">
            <div class="custom-container">
                <ul class="chat-list" id="chatContactTab">
                </ul>
            </div>
        </section>
        <!-- chat section end -->
    </div>

    <!-- bottom navbar start -->
    <div class="navbar-menu hide-on-chat-select">
        <ul>
            <li class="active">
                <a href="/">
                    <div class="icon">
                        <img class="unactive" src="~/chatzy/assets/images/svg/chat.svg" alt="chat">
                        <img class="active" src="~/chatzy/assets/images/svg/chat-fill.svg" alt="chat">
                    </div>
                    <span class="active">Chat</span>
                </a>
            </li>

            <li>
                <a href="#" onclick="GetSavedMessages()">
                    <div class="icon">
                        <img class="unactive" style="filter: brightness(0.5);" src="~/chatzy/assets/iconsax/save-2.svg" alt="SavedMessage">

                    </div>
                    <span>Saved Message</span>
                </a>
            </li>

            <li>
                <a href="#" id="profile-link">
                    <div class="icon">
                        <img class="unactive" src="~/chatzy/assets/images/svg/profile.svg" alt="profile">
                    </div>
                    <span>profile</span>
                </a>
            </li>
        </ul>
    </div>
    <!-- bottom navbar end -->
</div>

<!-- Profile Modal -->
<div class="modal fade" id="profileModal" tabindex="-1" aria-labelledby="profileModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" dir="rtl">
            <div class="modal-header">
                <h5 class="modal-title" id="profileModalLabel">پروفایل کاربر</h5>
                <button type="button" class="btn-close m-0 p-0" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <img id="modalProfilePic" src="" alt="تصویر پروفایل" class="img-fluid rounded-circle mb-3" style="width: 100px; height: 100px; object-fit: cover;">
                <h4 id="modalFullName"></h4>
            </div>
        </div>
    </div>
</div>

<!-- Sliding Chat Details Panel -->
<div id="chat-details-panel" class="chat-details-panel-container">
    <!-- Chat content will be loaded here -->
</div>

<!-- Sliding Group Info Panel -->
<div id="group-info-panel" class="chat-details-panel-container overflow-auto">
    <!-- Group info content will be loaded here -->
</div>


@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.2/dist/browser-image-compression.js"></script>
    <script src="~/lib/signalr/signalr.js"></script>
    <script src="~/lib/microsoft/signalr/dist/browser/signalr.min.js"></script>
    <script src="~/js/jalaaliConverter.js"></script>

    @* <script src="~/js/chatHub.js" asp-append-version="true"></script> *@
    <script src="~/js/utils.js" asp-append-version="true"></script>
    <script src="~/js/signalRHandlers.js" asp-append-version="true"></script>
    <script src="~/js/uiRenderer.js" asp-append-version="true"></script>
    <script src="~/js/messageManager.js" asp-append-version="true"></script>
    <script src="~/js/chatCore.js" asp-append-version="true"></script>
    <script src="~/js/chatMain.js" asp-append-version="true"></script>


    <script src="~/js/chatHubEvents.js" asp-append-version="true"></script>
    <script src="~/js/fileManagement.js" asp-append-version="true"></script>
    <script src="~/js/audio-player.js" asp-append-version="true"></script>
    <script src="~/js/modal-lightbox.js" asp-append-version="true"></script>
    <script src="~/js/mobile-layout-handler.js" asp-append-version="true"></script>
    <script src="~/js/notification.js" asp-append-version="true"></script>
    <script src="~/js/chatSearch.js" asp-append-version="true"></script>

    <script>

        // --- URL / history helpers for chat parameter ---
        function getChatParamFromUrl() {
            try {
                return new URL(window.location.href).searchParams.get('chat') || null;
            } catch (e) {
                return null;
            }
        }

        var chatSelectedTitle = "";

        function pushChatToUrl(groupType, chatId) {
            try {
                let chatParam;

                if (groupType === 'Private') {
                    // برای چت خصوصی، باید chatKey کامل را بسازیم
                    const currentUserId = parseInt($('#userId').val());
                    const otherUserId = parseInt(chatId);
                    const minId = Math.min(currentUserId, otherUserId);
                    const maxId = Math.max(currentUserId, otherUserId);
                    chatParam = `private_${minId}_${maxId}`;
                } else {
                    chatParam = `${groupType}_${chatId}`;
                }

                const url = new URL(window.location.href);
                url.searchParams.set('chat', chatParam);
                window.history.pushState({ chat: chatParam }, '', url);
            } catch (e) {
                console.error('pushChatToUrl error:', e);
            }
        }

        function replaceRemoveChatFromUrl() {
            try {
                const url = new URL(window.location.href);
                url.searchParams.delete('chat');
                history.replaceState({}, '', url.pathname + url.search);
            } catch (e) { console.error(e); }
        }

        function removeChatFromUrl() {
            try {
                const url = new URL(window.location.href);
                url.searchParams.delete('chat');
                history.pushState({}, '', url.pathname + url.search);
            } catch (e) { console.error(e); }
        }

        // Safe invoker that waits if window.GetSelectedChatMessages isn't defined yet
               // جایگزین تابع safeInvokeGetSelected قبلی با این نسخه
         function safeInvokeGetSelected(chatId, groupType) {
            if (typeof window.GetSelectedChatMessages === 'function') {
                try { window.GetSelectedChatMessages(chatId, groupType); } catch (err) { console.error(err); }
                return;
            }
            let tries = 0;
            const iv = setInterval(() => {
                if (typeof window.GetSelectedChatMessages === 'function') {
                    clearInterval(iv);
                    try { window.GetSelectedChatMessages(chatId, groupType); } catch (err) { console.error(err); }
                    return;
                }
                if (++tries > 50) {
                    clearInterval(iv);
                    console.warn('GetSelectedChatMessages not available after waiting.');
                }
            }, 50);
        }

        $(document).ready(function () {

            // If URL contains chat=... param, open it after scripts defined
            const urlChat = getChatParamFromUrl();
            const linkToChatId = ($('#linkToChatId').val() || '').toString().trim();

            // priority: explicit linkToChatId (server), then URL param
            const initialChat = linkToChatId || urlChat;
            if (initialChat) {
                const parts = initialChat.split('_').map(p => (p || '').trim()).filter(Boolean);
                if (parts.length >= 2) {
                    // Improved parsing:
                    // - If private chat (private_{id1}_{id2}) keep the full id part as "id1_id2"
                    // - Otherwise try to detect canonical order; fallback to join remaining parts
                    let groupType = parts[0];
                    let chatId = null;

                    if (groupType.toLowerCase() === 'private' && parts.length >= 3) {
                        const currentUserId = parseInt($('#userId').val());
                        const id1 = parseInt(parts[1]);
                        const id2 = parseInt(parts[2]);

                        if (!isNaN(currentUserId) && !isNaN(id1) && !isNaN(id2)) {
                            // Find the other user's ID
                            const otherUserId = currentUserId === id1 ? id2 : id1;
                            chatId = otherUserId.toString();
                            console.log('--private-- receiverId :', chatId);
                        } else {
                            // Fallback or error handling if IDs are not numbers
                            chatId = parts.slice(1).join('_');
                            console.error('Could not parse private chat user IDs.');
                        }
                    } else if (parts.length === 2) {
                        // Normal case like ClassGroup_2
                        const a = parts[0], b = parts[1];
                        
                        if (!/^\d+$/.test(a) && /^\d+$/.test(b)) {
                            groupType = a; chatId = b;
                        } else if (!/^\d+$/.test(b) && /^\d+$/.test(a)) {
                            // swapped like 2_ClassGroup  -> normalize
                            groupType = b; chatId = a;
                        } else {
                            // ambiguous, keep as-is
                            groupType = a; chatId = b;
                        }
                        console.log('--ClassGroup or channel-----------------------------chatid :', b);
                    } else {
                        // Fallback for other multi-part ids: use first as groupType and join the rest
                        groupType = parts[0];
                        chatId = parts.slice(1).join('_');
                        console.log('--multi-part ids-----------------------------chatid :', chatId);
                    }

                    // invoke loading with canonical groupType/chatId
                    safeInvokeGetSelected(chatId, groupType);
                    // ensure URL has canonical param (e.g. private_1_124644)
                    pushChatToUrl(groupType, chatId);
                }
            }

            // Emoji picker functionality
            $(document).on('click','.btn-emoji-picker', function(e) {
                e.preventDefault();
                $('#emoji-picker').toggle();
            });

            $(document).on('click','.emoji-btn', function() {
                const emoji = $(this).data('emoji');
                const input = $('#message-input');
                input.val(input.val() + emoji);
                input.focus();
            });

            // Hide emoji picker when clicking outside
            $(document).on('click', function(e) {
                if (!$(e.target).closest('.btn-emoji-picker, #emoji-picker').length) {
                    $('#emoji-picker').hide();
                }
            });

            // in-case some UI toggles need to run once
            $('.hide-on-chat-select').addClass('slide-out');
            $('.hide-on-chat-select').removeClass('slide-out');

        });



        // Profile modal click handler
        $(document).on('click', '#profile-link', function(e) {
            e.preventDefault();
            var profilePic = $('#userProfilePic').val();
            var fullName = $('#fullName').val();
            var profileImageLink = '/assets/media/avatar/' + profilePic;
            $('#modalProfilePic').attr('src', profileImageLink);
            $('#modalFullName').text(fullName);
            $('#profileModal').modal('show');
        });



        $(function () {
            GetUserChats();

            // When a chat is selected
            window.GetSelectedChatMessages = function(chatId, groupType,lastReadMessageId) {
                console.log("chatId selected = " + chatId + " and groupType : " + groupType);
                ChatActivated(chatId, groupType);
                console.log('select chat and get closest id : LastReadMessageIdOnChatList value is : ' + lastReadMessageId);
                $.ajax({
                    url: '/Home/GetChatMessages',
                    type: 'GET',
                    data: { chatId: chatId, groupType: groupType, messageId: lastReadMessageId },
                    success: function (data) {
                        $('#chat-details-panel').html(data).addClass('visible');

                        // push state so back/forward will reflect chat
                        try { pushChatToUrl(groupType, chatId); } catch (e) { console.error(e); }

                        window.chatApp.reAttachScrollListener();

                        if (typeof init_iconsax === 'function') {
                            init_iconsax();
                        }

                        $('.groupName').text(chatSelectedTitle);//--عنوان گروه
                        // مخفی کردن عناصر هنگام انتخاب چت
                        $('.hide-on-chat-select').addClass('slide-out');

                        GetPinnedChats(chatId, groupType);
                    },
                    error: function (error) {
                        console.error("Error fetching chat messages:", error);
                    }
                });
            };

            // When "Saved Messages" is selected
            window.GetSavedMessages = function() {
                $.ajax({
                    url: '/Home/GetSaveMessages',
                    type: 'GET',
                    success: function (data) {
                        $('#chat-details-panel').html(data).addClass('visible');

                        if (typeof init_iconsax === 'function') {
                            init_iconsax();
                        }
                        // مخفی کردن عناصر هنگام انتخاب saved messages
                        $('.hide-on-chat-select').addClass('slide-out');
                    },
                    error: function (error) {
                        console.error("Error fetching saved messages:", error);
                    }
                });
            };

            // When a private chat is selected
            window.GetPrivateChatMessages = function(otherUserId, chatName, lastReadMessageId) {
                console.log(`Loading private chat with user ${otherUserId}, name: ${chatName}`);
                chatSelectedTitle = chatName;
                // استفاده مستقیم از تابع موجود GetSelectedChatMessages
                // برای private messages، chatId = otherUserId (که OwnerId است)
                window.GetSelectedChatMessages(otherUserId, 'Private', lastReadMessageId);
            };

            // When closing the chat view to go back to the list
            $(document).on('click', '#close-chat-panel-btn', function() {
                $('#chat-details-panel').removeClass('visible');
                // Optional: clear content after animation
                setTimeout(function() {
                    $('#chat-details-panel').html('');
                }, 300);

                // update history / url: remove chat param (push so back returns to chat)
                try { removeChatFromUrl(); } catch (e) { console.error(e); }

                // نمایش دوباره عناصر هنگام برگشت از چت
                $('.hide-on-chat-select').removeClass('slide-out');  // جایگزین removeClass('hidden')
            });

            // handle browser back/forward
            window.addEventListener('popstate', function (event) {
                const state = (event && event.state) || {};
                const chatParam = state.chat || getChatParamFromUrl();

                if (chatParam) {
                    // open chat described in state
                    const parts = chatParam.split('_').map(p => (p || '').trim()).filter(Boolean);
                    if (parts.length >= 2) {
                        // Improved parsing (same logic as initial load):
                        // - If private chat (private_{id1}_{id2}) keep the full id part as "id1_id2"
                        // - Otherwise detect canonical order or fallback to join remaining parts
                        let groupType = parts[0];
                        let chatId = null;

                        if (groupType.toLowerCase() === 'private' && parts.length >= 3) {
                            const currentUserId = parseInt($('#userId').val());
                            const id1 = parseInt(parts[1]);
                            const id2 = parseInt(parts[2]);

                            if (!isNaN(currentUserId) && !isNaN(id1) && !isNaN(id2)) {
                                const otherUserId = currentUserId === id1 ? id2 : id1;
                                chatId = otherUserId.toString();
                            } else {
                                chatId = parts.slice(1).join('_');
                                console.error('Could not parse private chat user IDs from popstate.');
                            }
                        } else if (parts.length === 2) {
                            const a = parts[0], b = parts[1];
                            if (!/^\d+$/.test(a) && /^\d+$/.test(b)) {
                                groupType = a; chatId = b;
                            } else if (!/^\d+$/.test(b) && /^\d+$/.test(a)) {
                                groupType = b; chatId = a;
                            } else {
                                groupType = a; chatId = b;
                            }
                        } else {
                            // fallback for other multi-part ids
                            groupType = parts[0];
                            chatId = parts.slice(1).join('_');
                        }

                        safeInvokeGetSelected(chatId, groupType);
                    }
                } else {
                    // no chat in history state -> close chat panel
                    $('#chat-details-panel').removeClass('visible');
                    setTimeout(function() { $('#chat-details-panel').html(''); }, 300);
                    $('.hide-on-chat-select').removeClass('slide-out');
                }
            });

        });

        function GetUserChats() {
            $.ajax({
                url: '/Home/GetUserChats/',
                type: 'GET',
                success: function (data) {
                    $('#chatContactTab').html(data);
                    //console.log("Class groups for user on loaded");
                    if (typeof init_iconsax === 'function') {
                       init_iconsax();
                    }
                },
                error: function (error) {
                    console.error("Error fetching class groups:", error);
                }
            });
        };

        function GetPinnedChats(chatId, groupType) {
            console.log(`-----------------------Loading pinned messages for chatId: ${chatId}, groupType: ${groupType}--------------------------------`);

            // ✅ استفاده از data attributes برای پیدا کردن المان
            function findAndLoadPinnedMessages() {
                // جستجو برای المان با استفاده از data attributes
                var targetContainer = $(`[data-chat-id="${chatId}"][data-chat-type="${groupType}"].pinnedMessagesPlaceholder`);

                if (targetContainer.length === 0) {
                    //console.warn(`❌ Container not found for chatId: ${chatId}, groupType: ${groupType}`);
                    // دوباره تلاش کن
                    requestAnimationFrame(findAndLoadPinnedMessages);
                    return;
                }

                //console.log(`✅ Container found! Loading pinned messages...`);

                $.ajax({
                    url: '/Home/GetChatPinnedMessages/',
                    type: 'GET',
                    data: { chatId: chatId, groupType: groupType },
                    success: function (data) {
                        //console.log(`✅ Pinned messages loaded successfully for chatId: ${chatId}`);
                        targetContainer.html(data);

                        if (typeof init_iconsax === 'function') {
                            init_iconsax();
                        }
                    },
                    error: function (error) {
                        console.error(`❌ Error fetching pinned messages for chatId: ${chatId}`, error);
                        window.chatUIRenderer.showToast(`❌ Error fetching pinned messages for chatId: ${chatId}`, "error");
                    }
                });
            }

            // شروع جستجو
            findAndLoadPinnedMessages();
        }

       

        function ChatActivated(chatId, groupType) {
            console.log(`chat Id and group type is : ${chatId} and ${groupType}`);
            var selectedChat = $(`#${groupType}_${chatId}`);

            chatSelectedTitle = selectedChat.find('.name').text();
            console.log('---' + chatSelectedTitle);

            // ✅ ساخت صحیح selectedChatId
            let selectedChatId;

            if (groupType === 'Private') {
                const currentUserId = parseInt($('#userId').val());
                const otherUserId = parseInt(chatId);
                const minId = Math.min(currentUserId, otherUserId);
                const maxId = Math.max(currentUserId, otherUserId);
                selectedChatId = `private_${minId}_${maxId}`;
                console.log(`✅ Private chat key: ${selectedChatId}`);
            } else {
                selectedChatId = `${groupType}_${chatId}`;
            }
            window.activeGroupId = selectedChatId;
            if(selectedChat.length) {
                const chatItemsBody = $('#chatContactTab');
                const chatItems = chatItemsBody.find('.active');
                chatItems. removeClass('active');
                selectedChat.addClass('active');

                if (window.chatApp && window.chatApp.connection) {
                    if (window.activeGroupId) {
                        window.chatApp.connection.invoke("LeaveGroup", window.activeGroupId)
                            .catch(err => {
                                console.error('Error leaving group:', err);
                                window.chatUIRenderer.showToast("❌ خطا در ترک چت", "error");
                            });
                    }
                    window.chatApp. connection.invoke("JoinGroup", selectedChatId)
                        .catch(err =>{
                            console.error('Error joining group:', err);
                            window.chatUIRenderer. showToast("❌ خطا در پیوستن به چت", "error");
                        });
                }
                window.activeGroupId = selectedChatId; // ✅ مقدار صحیح ذخیره می‌شود
                console.log(" selcted chat and window.activeGroupId:", window.activeGroupId);
            }
        }

        window.GetChatDetails = function(chatId, groupType){
             $.ajax({
                 url: '/Home/GetChatDetails',
                 type: 'GET',
                 data: { chatId: chatId, groupType: groupType },
                 success: function (data) {
                     $('#group-info-panel').html(data).addClass('visible');
                     if (typeof init_iconsax === 'function') {
                         init_iconsax();
                     }
                     // After the panel is visible, load the online status for members
                     if (window.chatApp && typeof window.chatApp.loadAndDisplayOnlineUsers === 'function') {
                         window.chatApp.loadAndDisplayOnlineUsers(chatId, groupType);
                     }
                 },
                 error: function (error) {
                     console.error("Error fetching chat members:", error);
                     window.chatUIRenderer.showToast("❌ خطا در دریافت اطلاعات چت", "error");
                 }
             });
        }

        // When closing the group info panel to go back to the chat
        $(document).on('click', '#close-group-info-panel-btn', function (e) {
            e.preventDefault();
            $('#group-info-panel').removeClass('visible');
            // Optional: clear content after animation
            setTimeout(function () {
                $('#group-info-panel').html('');
            }, 300);
        });



        // --- Mobile Keyboard Layout Fix ---
        function adjustChatLayout() {
            const chatPanel = $('#chat-details-panel');
            if (!chatPanel.length || !chatPanel.hasClass('visible')) {
                return;
            }

            const initialHeight = window.innerHeight;
            chatPanel.css('height', `${initialHeight}px`);
            console.log(`Chat panel height set to: ${initialHeight}px`);

            // Adjust on keyboard show/hide
            $(window).on('resize.chatLayout', function () {
                const newHeight = window.innerHeight;
                chatPanel.css('height', `${newHeight}px`);
                console.log(`Chat panel resized to: ${newHeight}px`);
                // Scroll to the bottom of the messages
                const chatContent = $('#chat_content');
                if (chatContent.length) {
                    chatContent.scrollTop(chatContent.prop("scrollHeight"));
                }
            });
        }

        // Detach the listener when the panel is closed
        function cleanupChatLayout() {
            $(window).off('resize.chatLayout');
            console.log('Chat layout resize listener removed.');
        }

        // Observe the body for when the chat panel is added and made visible
        const observer = new MutationObserver(function (mutations) {
            mutations.forEach(function (mutation) {
                if (mutation.addedNodes.length) {
                    const chatPanel = $(mutation.addedNodes).find('#chat-details-panel').addBack('#chat-details-panel');
                    if (chatPanel.length && chatPanel.hasClass('visible')) {
                        console.log('Chat panel is now visible. Attaching layout adjuster.');
                        adjustChatLayout();
                    }
                }
                // Also check for attribute changes (like the 'visible' class)
                if (mutation.type === 'attributes' && $(mutation.target).is('#chat-details-panel')) {
                    const chatPanel = $(mutation.target);
                    if (chatPanel.hasClass('visible')) {
                        console.log('Chat panel became visible. Attaching layout adjuster.');
                        adjustChatLayout();
                    } else {
                        console.log('Chat panel is hidden. Cleaning up.');
                        cleanupChatLayout();
                    }
                }
            });
        });

        // Start observing the main content body for changes
        const config = { childList: true, subtree: true, attributes: true, attributeFilter: ['class'] };
        const targetNode = document.getElementById('main-content-body');
        // We need to observe a parent that is always present.
        // Let's observe the body itself for the #chat-details-panel.
        observer.observe(document.body, config);
    </script>
}
